<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chapter 2 — Signal Relay</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #06090f;
      --panel: #121a29;
      --panel-border: #2a3a57;
      --accent: #7ec8ff;
      --accent-strong: #42a5ff;
      --ok: #6bf2a3;
      --warn: #ff8f8f;
      --text: #e6eefc;
      --muted: #9aaccc;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #101a2d 0, var(--bg) 62%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 16px;
      touch-action: manipulation;
    }

    .game {
      width: min(640px, 100%);
      background: linear-gradient(180deg, #17233a 0%, #0d1524 100%);
      border: 1px solid var(--panel-border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    h1 {
      font-size: clamp(1.2rem, 3.6vw, 1.7rem);
      margin: 0 0 6px;
    }

    .subtitle {
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .status {
      min-height: 24px;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 12px;
    }

    .status.error { color: var(--warn); }
    .status.success { color: var(--ok); }

    .sequence {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }

    .step {
      border: 1px solid #395070;
      border-radius: 10px;
      padding: 8px 6px;
      text-align: center;
      color: #6f88ab;
      background: #0d1728;
      font-size: 0.84rem;
    }

    .step.done {
      border-color: #3f8f6e;
      color: var(--ok);
      background: #102920;
    }

    .step.current {
      border-color: var(--accent-strong);
      color: var(--accent);
      box-shadow: inset 0 0 0 1px #1b2f4d;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      max-width: 280px;
      margin: 0 auto;
    }

    .controls button {
      min-height: 62px;
      border-radius: 12px;
      border: 1px solid #375580;
      background: #10213a;
      color: var(--text);
      font-size: 1.2rem;
      font-weight: 700;
      user-select: none;
      touch-action: manipulation;
    }

    .controls button:active,
    .controls button.active {
      transform: translateY(1px) scale(0.98);
      background: #173258;
      border-color: var(--accent-strong);
    }

    .empty { visibility: hidden; }

    .hint {
      margin-top: 14px;
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .next-link {
      display: inline-block;
      margin-top: 14px;
      color: #97d5ff;
      text-decoration: none;
      border-bottom: 1px dashed #97d5ff66;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
    }

    .next-link.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <main class="game">
    <h1>Chapter 2: Signal Relay</h1>
    <p class="subtitle">Repeat each direction sequence correctly to open the gate.</p>
    <div id="status" class="status">Round 1 of 3. Watch closely…</div>
    <div id="sequence" class="sequence" aria-live="polite"></div>

    <div class="controls" role="group" aria-label="Direction controls">
      <button class="empty" tabindex="-1" aria-hidden="true">.</button>
      <button data-dir="up" aria-label="Up">▲</button>
      <button class="empty" tabindex="-1" aria-hidden="true">.</button>
      <button data-dir="left" aria-label="Left">◀</button>
      <button data-dir="down" aria-label="Down">▼</button>
      <button data-dir="right" aria-label="Right">▶</button>
    </div>

    <p class="hint">Desktop: Arrow keys or WASD. Mobile: tap the direction pad.</p>
    <a id="next-link" class="next-link" href="/chapter3/">Continue to next chapter pending →</a>
  </main>

  <script>
    const DIRECTIONS = ["up", "down", "left", "right"];
    const SYMBOLS = { up: "▲", down: "▼", left: "◀", right: "▶" };
    const KEY_MAP = {
      KeyW: "up", ArrowUp: "up",
      KeyS: "down", ArrowDown: "down",
      KeyA: "left", ArrowLeft: "left",
      KeyD: "right", ArrowRight: "right"
    };

    const statusEl = document.getElementById("status");
    const sequenceEl = document.getElementById("sequence");
    const nextLinkEl = document.getElementById("next-link");
    const buttons = Array.from(document.querySelectorAll("button[data-dir]"));

    let round = 1;
    let pattern = [];
    let cursor = 0;
    let acceptingInput = false;

    function randomDirection() {
      return DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
    }

    function makePattern() {
      const length = round + 2; // 3, 4, 5
      pattern = Array.from({ length }, randomDirection);
      cursor = 0;
      renderPattern();
    }

    function renderPattern() {
      sequenceEl.innerHTML = "";
      pattern.forEach((dir, i) => {
        const step = document.createElement("div");
        step.className = "step";
        if (i < cursor) {
          step.classList.add("done");
          step.textContent = SYMBOLS[dir];
        } else if (i === cursor && acceptingInput) {
          step.classList.add("current");
          step.textContent = "?";
        } else {
          step.textContent = "•";
        }
        sequenceEl.appendChild(step);
      });
    }

    function setStatus(text, cls = "") {
      statusEl.className = `status ${cls}`.trim();
      statusEl.textContent = text;
    }

    async function showPattern() {
      acceptingInput = false;
      renderPattern();
      setStatus(`Round ${round} of 3. Memorise the pattern…`);

      for (let i = 0; i < pattern.length; i++) {
        const dir = pattern[i];
        const btn = buttons.find((b) => b.dataset.dir === dir);
        if (btn) {
          btn.classList.add("active");
          await delay(300);
          btn.classList.remove("active");
          await delay(160);
        }
      }

      acceptingInput = true;
      setStatus(`Your turn: step ${cursor + 1} of ${pattern.length}`);
      renderPattern();
    }

    function completeGame() {
      acceptingInput = false;
      setStatus("Signal stable. Path unlocked.", "success");
      nextLinkEl.classList.add("visible");
      setTimeout(() => {
        window.location.href = "/chapter3/";
      }, 1200);
    }

    function failStep() {
      acceptingInput = false;
      cursor = 0;
      setStatus("Signal mismatch. Restarting round…", "error");
      renderPattern();
      setTimeout(() => {
        showPattern();
      }, 700);
    }

    function handleDirection(dir) {
      if (!acceptingInput || !dir) return;

      const expected = pattern[cursor];
      if (dir !== expected) {
        failStep();
        return;
      }

      cursor++;
      renderPattern();

      if (cursor >= pattern.length) {
        if (round >= 3) {
          completeGame();
        } else {
          round++;
          round++;
          acceptingInput = false;
          setTimeout(() => {
            setStatus(`Round ${round - 1} complete. Preparing round ${round}…`, "success");
            makePattern();
            showPattern();
          }, 800);
        }
      } else {
        setStatus(`Your turn: step ${cursor + 1} of ${pattern.length}`);
      }
    }

    buttons.forEach((button) => {
      const dir = button.dataset.dir;
      const onPress = (e) => {
        if (e) e.preventDefault();
        handleDirection(dir);
      };
      button.addEventListener("pointerdown", onPress);
    });

    window.addEventListener("keydown", (event) => {
      const dir = KEY_MAP[event.code] || KEY_MAP[event.key];
      if (!dir) return;
      event.preventDefault();
      handleDirection(dir);
    });

    makePattern();
    showPattern();
  </script>
</body>
</html>
